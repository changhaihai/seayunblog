---

import { execSync } from "node:child_process";
import { profileConfig } from "../config";
import { url } from "../utils/url-utils";

const currentYear = new Date().getFullYear();

let commitHash = "unknown";
let buildDate = "unknown";

try {
	commitHash = execSync("git rev-parse --short=7 HEAD").toString().trim();

	const date = new Date();
	const year = date.getFullYear();
	const month = (date.getMonth() + 1).toString().padStart(2, "0");
	const day = date.getDate().toString().padStart(2, "0");
	const hours = date.getHours().toString().padStart(2, "0");
	const minutes = date.getMinutes().toString().padStart(2, "0");
	const seconds = date.getSeconds().toString().padStart(2, "0");
	buildDate = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
} catch (e) {
	console.warn("Failed to get git info", e);
}
---

<div class="border-t border-black/10 dark:border-white/15 my-10 border-dashed mx-4 md:mx-32"></div>
<div class="card-base w-fit mx-auto rounded-xl mt-4 mb-8 p-1 bg-gradient-to-br from-white/90 to-white/70 dark:from-gray-900/90 dark:to-gray-800/70 backdrop-blur-sm shadow-md hover:shadow-lg transition-all duration-300">
    <div class="text-sm text-center p-8 text-gray-700 dark:text-gray-300">
        <!-- 版权信息 -->
        <p class="mb-2 leading-relaxed">
            &copy; <span id="copyright-year">2024 - {currentYear}</span> 
            <a class="link text-primary font-medium hover:text-primary/80 transition-colors duration-200" target="_blank" href="https://space.bilibili.com/325903362">
                {profileConfig.name}
            </a>，采用
            <a class="link text-primary font-medium hover:text-primary/80 transition-colors duration-200" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
                CC BY-NC-SA 4.0
            </a> 许可
        </p>

        <!-- 功能链接 -->
        <p class="mb-3 flex flex-wrap justify-center gap-x-2 gap-y-1">
            <a class="link text-primary font-medium hover:text-primary/80 transition-colors duration-200" target="_blank" href={url('rss.xml')}>RSS</a>
            <span class="text-gray-500 dark:text-gray-400">/</span>
            <a class="link text-primary font-medium hover:text-primary/80 transition-colors duration-200" target="_blank" href={url('sitemap-index.xml')}>网站地图</a>
        </p>

        <!-- 技术驱动 -->
        <p class="mb-3 leading-relaxed">
            由
            <a class="link text-primary font-medium hover:text-primary/80 transition-colors duration-200" target="_blank" href="https://astro.build">Astro</a> 
            <span class="text-gray-500 dark:text-gray-400">和</span>
            <a class="link text-primary font-medium hover:text-primary/80 transition-colors duration-200" target="_blank" href="https://github.com/saicaca/fuwari">Fuwari</a> 
            <span class="inline-block animate-pulse">强力驱动</span>
        </p>

        <!-- 提交信息 -->
        <p class="mb-4 text-xs text-gray-500 dark:text-gray-400 hover:text-primary/60 transition-colors duration-200">
            <a class="link" target="_blank" href={`https://github.com/afoim/fuwari/commit/${commitHash}`}>
                ({commitHash} @ {buildDate})
            </a>
        </p>

        <!-- 备案信息（若启用） -->
        <!-- <p class="mb-2 flex items-center justify-center text-xs">
            <a class="link flex items-center text-gray-500 dark:text-gray-400 hover:text-primary transition-colors duration-200" href="https://beian.miit.gov.cn/#/Integrated/index" target="_blank">
                <img alt="ICP备案图标" src="/favicon/foot-icp.png" class="h-4 mr-1">
                皖ICP备2025099787号-2
            </a>
        </p>
        <p class="flex items-center justify-center text-xs">
            <a class="link flex items-center text-gray-500 dark:text-gray-400 hover:text-primary transition-colors duration-200" href="https://beian.mps.gov.cn/#/query/webSearch?code=34010302002608" target="_blank">
                <img alt="公安备案图标" src="/favicon/foot-ga.png" class="h-4 mr-1">
                皖公网安备34010302002608号
            </a>
        </p> -->

        <!-- 服务器信息 -->
        <div class="server-info-wrapper flex items-center justify-center mt-3 text-xs text-gray-500 dark:text-gray-400">
            <span class="server-info"></span>
            <img class="server-icon h-5 ml-1 bg-white rounded p-0.5 shadow-sm hover:scale-110 transition-transform duration-200" alt="Server Icon">
        </div>
    </div>
</div>


<script>
    function updateServerInfo(server) {
        const wrappers = document.querySelectorAll('.server-info-wrapper');
        wrappers.forEach(wrapper => {
            const serverInfo = wrapper.querySelector('.server-info');
            const serverIcon = wrapper.querySelector('.server-icon');
            if (serverInfo) {
                if (server) {
                    serverInfo.innerText = `访问节点：${server}`;
                    if (serverIcon) {
                        const serverLower = server.toLowerCase();
                        if (serverLower === 'edgeone-pages') {
                            serverIcon.src = '/cdn/eo.png';
                            serverIcon.classList.remove('hidden');
                            serverInfo.classList.add('hidden');
                        } else if (serverLower === 'cloudflare') {
                            serverIcon.src = '/cdn/cf.svg';
                            serverIcon.classList.remove('hidden');
                            serverInfo.classList.add('hidden');
                        } else if (serverLower === 'esa') {
                            serverIcon.src = '/cdn/esa.svg';
                            serverIcon.classList.remove('hidden');
                            serverInfo.classList.add('hidden');
                        } else {
                            serverIcon.classList.add('hidden');
                            serverInfo.classList.remove('hidden');
                        }
                    }
                } else {
                    serverInfo.innerText = "访问节点：未知";
                    serverInfo.classList.remove('hidden');
                    if (serverIcon) serverIcon.classList.add('hidden');
                }
            }
        });
    }

    function initServerInfo() {
        const isDevMode = localStorage.getItem("dev-mode") === "true";
        if (isDevMode) {
            const devServer = localStorage.getItem("dev-server");
            updateServerInfo(devServer);
        } else {
            const url = window.location.href;
            fetch(url, { method: "HEAD" })
                .then(response => {
                    const server = response.headers.get('server');
                    updateServerInfo(server);
                })
                .catch(error => {
                    console.error("Failed to fetch server info:", error);
                    updateServerInfo(null);
                });
        }
    }

    initServerInfo();
    document.addEventListener('astro:after-swap', initServerInfo); // Support View Transitions if enabled
    // Support Swup if enabled (listen to content replacement)
    document.addEventListener('content:replace', initServerInfo);
</script>
